<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarketBot Admin Access</title>
    <link rel="icon" href="../logo.png" type="image/png">
    
    <!-- Load global announcement system -->
    <script src="../global-announcements.js"></script>
    <script src="global-storage.js"></script>
</head>
<body>
    <!-- Content will be dynamically loaded by auth system -->
    <div id="app-container">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Loading admin interface...</p>
        </div>
    </div>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .loading-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Login Form Styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .login-form {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .login-logo {
            width: 60px;
            height: 60px;
            margin-bottom: 20px;
            border-radius: 10px;
        }
        
        .login-form h2 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .login-form p {
            color: #666;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            border: 1px solid #f5c6cb;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            border: 1px solid #c3e6cb;
        }
        
        .login-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .login-footer a {
            color: #667eea;
            text-decoration: none;
        }
        
        .login-footer a:hover {
            text-decoration: underline;
        }
    </style>

    <!-- Secure Admin Authentication System -->
    <script>
        // Secure admin authentication system
        class SecureAdminAuth {
            constructor() {
                this.sessionKey = 'marketbot_admin_session';
                this.maxSessionTime = 30 * 60 * 1000; // 30 minutes
                this.init();
            }

            init() {
                this.checkExistingSession();
            }

            // Secure password verification using SHA-256 hashing
            async verifyPassword(password) {
                const encoder = new TextEncoder();
                const data = encoder.encode(password + 'marketbot_security_salt_2025');
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashedPassword = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                
                // Server-side equivalent hash for 'marketbot_admin_2025'
                const validHash = 'bc683774a01cd54c2e9ffb13865dbda7d90cdfa106eefe51ad15292af2d37dbb';
                
                return this.constantTimeCompare(hashedPassword, validHash);
            }

            // Prevent timing attacks with constant-time comparison
            constantTimeCompare(a, b) {
                if (a.length !== b.length) return false;
                let result = 0;
                for (let i = 0; i < a.length; i++) {
                    result |= a.charCodeAt(i) ^ b.charCodeAt(i);
                }
                return result === 0;
            }

            // Create secure session
            createSession() {
                const sessionData = {
                    authenticated: true,
                    timestamp: Date.now(),
                    token: this.generateSecureToken()
                };
                localStorage.setItem(this.sessionKey, JSON.stringify(sessionData));
            }

            // Generate cryptographically secure session token
            generateSecureToken() {
                const array = new Uint8Array(32);
                crypto.getRandomValues(array);
                return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
            }

            // Validate current session
            isAuthenticated() {
                const session = this.getSession();
                if (!session) return false;
                
                const sessionAge = Date.now() - session.timestamp;
                if (sessionAge > this.maxSessionTime) {
                    this.logout();
                    return false;
                }
                
                return session.authenticated === true && session.token;
            }

            getSession() {
                try {
                    const sessionStr = localStorage.getItem(this.sessionKey);
                    return sessionStr ? JSON.parse(sessionStr) : null;
                } catch (error) {
                    return null;
                }
            }

            checkExistingSession() {
                if (this.isAuthenticated()) {
                    this.loadAdminDashboard();
                } else {
                    this.showLoginForm();
                }
            }

            showLoginForm() {
                document.getElementById('app-container').innerHTML = `
                    <div class="login-container">
                        <div class="login-form">
                            <img src="../logo.png" alt="MarketBot" class="login-logo">
                            <h2>Admin Access</h2>
                            <p>Enter credentials to access the admin dashboard</p>
                            
                            <form id="loginForm">
                                <div class="form-group">
                                    <label for="adminPassword">Admin Password:</label>
                                    <input type="password" id="adminPassword" required autocomplete="new-password">
                                </div>
                                
                                <button type="submit" class="btn btn-primary">Access Dashboard</button>
                                
                                <div id="loginError" class="error-message" style="display: none;"></div>
                            </form>
                            
                            <div class="login-footer">
                                <p><a href="../">‚Üê Back to MarketBot</a></p>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('loginForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleLogin();
                });

                // Focus password field
                document.getElementById('adminPassword').focus();
            }

            async handleLogin() {
                const password = document.getElementById('adminPassword').value;
                const errorDiv = document.getElementById('loginError');
                
                if (!password) {
                    this.showError('Please enter the admin password');
                    return;
                }

                try {
                    const isValid = await this.verifyPassword(password);
                    
                    if (isValid) {
                        this.createSession();
                        this.loadAdminDashboard();
                    } else {
                        this.showError('Invalid credentials. Access denied.');
                        document.getElementById('adminPassword').value = '';
                        
                        // Security delay after failed attempt
                        setTimeout(() => {
                            document.getElementById('adminPassword').disabled = false;
                        }, 2000);
                        document.getElementById('adminPassword').disabled = true;
                    }
                } catch (error) {
                    this.showError('Authentication error. Please try again.');
                }
            }

            showError(message) {
                const errorDiv = document.getElementById('loginError');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }

            async loadAdminDashboard() {
                try {
                    const response = await fetch('dashboard.html');
                    const dashboardHtml = await response.text();
                    
                    document.getElementById('app-container').innerHTML = dashboardHtml;
                    this.initializeDashboard();
                } catch (error) {
                    console.error('Failed to load dashboard.html, using fallback:', error);
                    this.createFallbackDashboard();
                }
            }

            initializeDashboard() {
                // Add session timeout warning
                this.setupSessionTimeout();
                
                // Initialize announcement system with delay to ensure DOM is ready
                setTimeout(() => {
                    console.log('Initializing dashboard...');
                    console.log('trueGlobalStorage available:', !!window.trueGlobalStorage);
                    console.log('globalAnnouncements available:', !!window.globalAnnouncements);
                    
                    if (typeof loadActiveAnnouncements === 'function') {
                        console.log('Loading active announcements...');
                        loadActiveAnnouncements();
                    } else {
                        console.warn('loadActiveAnnouncements function not found');
                    }
                }, 500);
            }

            createFallbackDashboard() {
                document.getElementById('app-container').innerHTML = `
                    <div class="admin-container">
                        <header class="admin-header">
                            <div class="header-content">
                                <div class="admin-title">
                                    <img src="../logo.png" alt="MarketBot" class="admin-logo" style="width: 40px; height: 40px; border-radius: 8px;">
                                    <h1>MarketBot Admin Dashboard</h1>
                                </div>
                                <button onclick="adminAuth.logout()" class="btn btn-secondary">Logout</button>
                            </div>
                        </header>

                        <main style="max-width: 1200px; margin: 0 auto; padding: 2rem;">
                            <div style="background: white; border-radius: 10px; padding: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <h2>Admin Dashboard</h2>
                                <p>Welcome to the secure MarketBot admin interface.</p>
                                <p>Dashboard functionality loading...</p>
                            </div>
                        </main>
                    </div>
                `;
            }

            setupSessionTimeout() {
                // Warn user 5 minutes before session expires
                setTimeout(() => {
                    if (this.isAuthenticated()) {
                        const warningDiv = document.createElement('div');
                        warningDiv.className = 'error-message';
                        warningDiv.textContent = 'Session will expire in 5 minutes. Please save your work.';
                        warningDiv.style.position = 'fixed';
                        warningDiv.style.top = '20px';
                        warningDiv.style.right = '20px';
                        warningDiv.style.zIndex = '10000';
                        document.body.appendChild(warningDiv);
                        
                        setTimeout(() => warningDiv.remove(), 10000);
                    }
                }, this.maxSessionTime - 5 * 60 * 1000);
            }

            logout() {
                localStorage.removeItem(this.sessionKey);
                window.location.reload();
            }
        }

        // Initialize secure admin authentication
        const adminAuth = new SecureAdminAuth();
    </script>
</body>
</html>